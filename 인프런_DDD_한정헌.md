# Microservice 내부 아키텍팅 & 설계(with DDD,EventStorming)


## 도메인 주도 설계(전술적 설계 이해)
- 애그리거트, 엔티티, 값 객체, 도메인 이벤트로 도메인 모델을 표현할 수 있음.

### 비즈니스 로직 구현 패턴 1 : 트랜잭션 스크립트

### 비즈니스 로직 구현 패턴 2 : 액티브 레코드

### 비즈니스 로직 구현 패턴 3 : 도메인 모델 패턴
- 도메인 모델은 행위+데이터를 통해 비즈니스 로직 구현
- 응용 서비스에서는 대부분 업무 흐름 제어만 하며, 주요 비즈니스 로직은 도메인 모델에 위임하여 처리
<img width="600" alt="스크린샷 2023-10-15 오후 8 07 21" src="https://github.com/daadaadaah/my-ddd/assets/60481383/8b483e4d-f6b9-40e9-a531-7b7aeec2f635">

### 비즈니스 로직 구현 패턴 4 :  애그리거트 패턴
- 도메인 모델 패턴 적용시 도메인 모델이 점점 복잡해지고 비대해짐
- 이런 복잡성을 관리할 단위로, Aggregate를 사용
- 대부분 1개의 Entity와 여러 개의 VO로 구성
<img width="600" alt="스크린샷 2023-10-15 오후 8 08 47" src="https://github.com/daadaadaah/my-ddd/assets/60481383/51dcc6e2-d0b7-4391-a0a8-5af72675830a">

#### 애그리거트 패턴의 구성요소 1. Value Object

#### 애그리거트 패턴의 구성요소 2. Entity

#### 애그리거트 패턴의 구성요소 3. Aggregate
- 관련 객체를 하나로 묶은 군집
- Aggregate의 목적은 데이터 일관성 보호에 있고, 데이터 변경시 Aggregate 단위로 처리
- Aggregate Root를 통해 Aggregate 내의 다른 Entity 및 VO 접근
- 데이터 변경 단위, 트랜잭션 단위가 되어, 관련된 객체들끼리 묶어주는 역할로 이해하면 된다.

##### Aggregate 설계 고려사항 1
- 1개의 TX에서는 1개의 Aggregate만 수정함.
- TX 일관성과 성공을 보장하도록 Aggregate 구성요소들을 설계해야 함.
<특징>
- 각 Aggregate은 일관성 있는 TX 경계를 형성함.
- 즉, TX 제어가 DB에 Commit 될 때, 한 Aggregate 내의 모든 구성요소들은 비즈니스 규칙을 따르면서 일관성 있게 처리되어야 함.

##### Aggregate 설계 고려사항 2
- 하나의 일을 잘 수행할 수 있도록 작게 설계해야 함.
- 작게 설계할수록 성능이 좋고 확장에 용이함. 변경사항 Commit할 때, 문제도 거의 발생되지 않음
<큰 Aggregate의 문제점>
- 시간이 지날수록 하위의 객체의 인스턴스의 증가가 결국 엄청난 크기로 불어날 수 있음
- 따라서, 하나의 일을 잘 수행할 수 있는 작은 Aggregate로 부리해야 함.

##### Aggregate 설계 고려사항 3
- 한 Aggregate 에서 다른 Aggregate의 참조는 직접 참조하지 말고 식별자를 통해서만 참조해야 함.
- 하나의 Transaction 내에서 여러 개의 Aggregate이 수정되는 것을 방지할 수 있음

##### Aggregate 설계 고려사항 4
- 하나의 TX에서 여러 개의 Aggregate이 갱신되어야 하는 경우, 다른 Aggregate의 갱신은 비동기 통신을 활용해서 결과적 일관성을 맞춰야 함.
<결과적 일관성이란>
- 일관성을 유지시켜야 하는 데이터가 일정시간 다른 데이터와 일치하지 않을 수도 있지만, 어느 시점이 되면 결국 일치하게 된다.


cf. MSA 서비스 단위가 BC 단위도 될 수 있고, Aggregate 단위로도 될 수 있다.

#### 애그리거트 패턴의 구성요소 4. Domain Event
- 비즈니스 일관성을 도메인 이벤트로 맞춘다.

- 비즈니스 도메인에서 일어난 중요한 이벤트를 설명하는 메시지
- '과거형'으로 명명
- Aggregate의 퍼블릭 인터페이스의 일부
- Aggregate는 자신의 Domain Event를 발행


#### 애그리거트 패턴의 구성요소 5. Domain Service
- 특정 Entity/Value Objects 에 속하지 않는 도메인 로직이나 복수의 Aggregate에 관련된 비즈니스 로직을 표현할 때 사용한다.
- 어떤 계산이나 분석을 위해 다양한 시스템 구성요소의 호출을 조율
<특징>
- 상태가 없는 객체
- 비즈니스 처리를 위해 다수의 Aggregate이 포함되어야 하는 경우, Service 객체를 만들어서 처리함
- 여러 Aggregate의 데이터를 읽는 것이 필요한 계산 로직 구현을 도와줌

#### 애그리거트 패턴의 구성요소 6. Repository
- 정의 : 도메인 모델의 영속성을 처리
- 도메인 모델을 사용하기 위해서 Repository를 통해 도메인 객체를 조회한 후 도메인 객체의 기능을 실행
- 도메인 객체(Aggregate)에 대한 생명주기, 즉 영속성 관리(등록, 조회, 수정, 삭제시 Aggregate의 일관성 유지)
- Spring Data JPA의 Repository 인터페이스

#### 애그리거트 패턴의 구성요소 7. Fatory
- 정의 : 복잡한 Entity 또는 Aggregate 생성을 전담하느 객체
<특징>
- 객체의 생성 과정과 관련된 지식이 정리된 객체로, 특정 정보를 Factory에 보내면 결과로 Entity 또는 Aggregate를 생성함.
- 복잡한 생성 로직을 숨겨, 개발자들이 내부의 복잡함에 신경쓰지 않아도 됨

### 응용 서비스


### 비즈니스 로직 구현 패턴 5 : 이벤트 소싱 패턴





